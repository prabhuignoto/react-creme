@use '@design/core.scss';
@use '@design/theme.scss';
@use '@design/tokens.scss';
@use '@design/animate.scss';
@use '@design/position.scss';
@use '@design/font.scss';
@use 'sass:map';

$sizes: (
  sm: (
    height: 25px,
    border-radius: 20px,
  ),
  md: (
    height: 30px,
    border-radius: 30px,
  ),
  lg: (
    height: 35px,
    border-radius: 40px,
  ),
);

$knob-sizes: (
  sm: 16px,
  md: 20px,
  lg: 24px,
);

$switch-width: (
  sm: calc(map.get($knob-sizes, sm) * 3),
  md: calc(map.get($knob-sizes, md) * 3),
  lg: calc(map.get($knob-sizes, lg) * 3),
);

// Knob offset from track edge (provides visual spacing)
$start-left: tokens.$space-1;

.switch {
  // Grid layout for switch + label (always external)
  align-items: center;
  display: grid;
  cursor: pointer;
  padding: tokens.$space-1;
  user-select: none;
  border-radius: 24px;
  transition: all 0.2s ease;

  @media (prefers-reduced-motion: reduce) {
    transition: none;
  }

  // Grid columns for each size (track + label)
  // Use 1fr for label column to automatically expand to available space
  @each $key, $value in $switch-width {
    &.#{$key} {
      grid-template-columns: $value 1fr;
    }
  }

  // Add gap between track and label columns
  gap: tokens.$space-2;

  // Dark mode text color
  &.dark {
    color: theme.$white;
  }

  // Focus indicator - WCAG 2.4.7 compliant
  &:focus,
  &:focus-visible {
    outline: 2px solid theme.$primary;
    outline-offset: 2px;
  }

  &.disabled {
    @extend %disabled;
    cursor: not-allowed;

    &:focus-visible {
      outline-color: theme.$gray-600;
    }
  }

  &.read_only {
    cursor: default;
    opacity: 0.8;

    &:focus-visible {
      outline-color: theme.$primary;
    }
  }
}

.disabled {
  .knob {
    & {
      box-shadow: none;
      background-color: theme.$gray-300;

      &.dark {
        background-color: theme.$steel-gray;
      }
    }
  }
}

// Loading state
.loading_spinner {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% {
    opacity: 0.5;
  }
  50% {
    opacity: 1;
  }
}

.track {
  @extend %center;
  height: 100%;
  position: relative;
  width: 100%;
  z-index: 0;

  @each $key, $val in $sizes {
    &.#{$key} {
      @each $attr, $value in $val {
        #{$attr}: #{$value};
      }
    }
  }
}

.track_on {
  // Improved visual clarity - clear blue for ON state
  background: theme.$primary;
  border: 1px solid theme.$primary;
  transition: all 0.2s ease;

  @media (prefers-reduced-motion: reduce) {
    transition: none;
  }

  &.dark {
    background: theme.$primary;
    border: 1px solid theme.$primary;
  }

  &:not(.dark) {
    background: theme.$primary;
    border: 1px solid theme.$primary;
  }
}

.track_off {
  // Clear gray for OFF state - better contrast
  background-color: theme.$gray-200;
  border: 1px solid theme.$gray-300;
  transition: all 0.2s ease;

  @media (prefers-reduced-motion: reduce) {
    transition: none;
  }

  &.dark {
    background-color: theme.$cod-gray;
    border: 1px solid theme.$chinese-gray;
  }
}

.track_disabled {
  background: theme.$gray-100;
  border: 1px solid theme.$gray-300;
  filter: grayscale(100%);

  &.dark {
    background: theme.$cod-gray;
    border: 1px solid theme.$steel-gray;
  }
}

.track_read_only {
  opacity: 0.8;
}

.knob:not(.on):not(.on-load) {
  @extend %shadow-small;

  svg {
    color: theme.$steel-gray;
  }
}

.knob {
  // CSS properties before animation mixins to comply with Sass mixed-decls
  border-radius: 50%;
  display: block;
  left: $start-left;
  transition: background-color 0.1s ease;
  z-index: 1;
  // Animation mixins that generate @keyframes (nested rules) come after properties
  @include animate.set-settings(0.2s);
  @include position.position-abs('center left');

  svg {
    @include position.position-abs('center center');
    color: theme.$white;
    height: 85%;
    width: 85%;
  }

  @each $key, $val in $knob-sizes {
    &.knob_#{$key} {
      $settings: (
        from: (
            left: $start-left,
          ),
        to: (
            left: calc(100% - $val - $start-left),
          ),
      );
      background-color: theme.$white;
      height: $val;
      width: $val;

      &.on_load {
        // Knob stays white for visibility on blue ON state (visual affordance)
        left: calc(100% - $val - $start-left);

        svg {
          color: theme.$primary;
        }
      }

      &.disabled {
        background-color: theme.$white;
      }

      &.on {
        @extend %shadow-medium;
        // CSS properties before nested rules to comply with Sass mixed-decls
        animation-name: slide-right-#{$key};
        // Knob stays white for visibility on blue ON state (visual affordance)
        left: calc(100% - $val - $start-left);

        // Nested rules come after properties
        & {
          box-shadow: none;
        }

        // Check icon color - blue for visibility on white knob
        svg {
          color: theme.$primary;
        }

        // Animation mixins that generate @keyframes (nested rules) come last
        @include animate.set-keyframes(slide-right-#{$key}, $settings);
      }

      &.off {
        // CSS properties before animation mixins to comply with Sass mixed-decls
        animation-name: slide-left-#{$key};
        right: calc(100% - $val - $start-left);
        left: unset;
        // Animation mixins that generate @keyframes (nested rules) come after properties
        @include animate.set-keyframes(slide-left-#{$key}, $settings, true);
      }
    }
  }
}

.label {
  @extend %text-no-wrap;
  // Allow label to shrink if needed, but maintain min-width for readability
  min-width: 0;

  &.label_on {
    color: theme.$primary;
  }

  @each $key, $val in $sizes {
    &.label_#{$key} {
      @extend %font-#{$key};
    }
  }

  // Label always outside (external)
  @extend %left;
}
